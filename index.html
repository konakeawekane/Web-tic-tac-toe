<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Tic-Tac-Toe (Real-Time)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .game-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 300px;
            height: 300px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .cell {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3.5rem;
            font-weight: 700;
            cursor: pointer;
            border: 3px solid #e0e0e0;
            transition: background-color 0.15s;
            user-select: none;
        }
        .cell:hover:not(.occupied):not(.disabled) {
            background-color: #f0f4f8;
        }
        .cell:nth-child(3n) { border-right: none; }
        .cell:nth-child(n+7) { border-bottom: none; }
        .cell:nth-child(3n+1) { border-left: none; }
        .cell:nth-child(-n+3) { border-top: none; }

        .x-player { color: #ef4444; } /* Red-500 */
        .o-player { color: #3b82f6; } /* Blue-500 */
    </style>
</head>
<body>

    <div id="app" class="p-6 md:p-10 bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Real-Time Tic-Tac-Toe</h1>
        <p id="user-info" class="text-sm text-gray-500 mb-6 text-center"></p>

        <!-- Connection/Game Setup Screen -->
        <div id="setup-container" class="space-y-4">
            <button id="create-game-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition">
                Create New Game (You will be X)
            </button>

            <div class="flex items-center space-x-2">
                <input type="text" id="join-game-input" placeholder="Enter Game ID to Join" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <button id="join-game-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition">
                    Join Game (You will be O)
                </button>
            </div>
        </div>

        <!-- Game Board and Status Display -->
        <div id="game-container" class="hidden">
            <div id="status-message" class="p-4 mb-4 rounded-lg font-semibold text-center transition-colors duration-300">
                Waiting for an opponent...
            </div>

            <div class="flex justify-center mb-6 space-x-4 text-center">
                <div id="player-x-card" class="p-3 rounded-lg shadow-md border-2 border-transparent transition-all duration-200">
                    <span class="text-xl font-bold x-player">X</span>
                    <p class="text-xs text-gray-500">Player X</p>
                </div>
                <div id="player-o-card" class="p-3 rounded-lg shadow-md border-2 border-transparent transition-all duration-200">
                    <span class="text-xl font-bold o-player">O</span>
                    <p class="text-xs text-gray-500">Player O</p>
                </div>
            </div>

            <div id="board" class="game-grid mx-auto bg-white rounded-xl overflow-hidden">
                <!-- Cells will be generated by JS -->
            </div>

            <button id="new-game-btn" class="hidden w-full mt-6 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg transition">
                Start New Game
            </button>
        </div>

        <!-- Custom Message Modal -->
        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-3">Game Message</h3>
                <p id="modal-content" class="text-gray-600 mb-4"></p>
                <button onclick="document.getElementById('modal').classList.add('hidden')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, updateDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level to debug for better error tracking
        setLogLevel('debug');

        // --- GLOBAL STATE & FIREBASE SETUP ---
        
        // ***********************************************************************************
        // --- IMPORTANT: CONFIGURATION FOR PUBLIC DEPLOYMENT (GitHub Actions Target) ---
        // GitHub Actions will replace these placeholder strings with your actual secrets.
        const PLACEHOLDER_FIREBASE_CONFIG = {
            apiKey: __SECRET_API_KEY__, 
            authDomain: __SECRET_AUTH_DOMAIN__, 
            projectId: __SECRET_PROJECT_ID__, 
            storageBucket: __SECRET_STORAGE_BUCKET__,
            messagingSenderId: __SECRET_SENDER_ID__,
            appId: __SECRET_APP_ID__
        };
        // ***********************************************************************************

        // Check if environment configuration is present (i.e., running in the sandbox)
        const hasEnvironmentConfig = typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0;
        
        // Use environment config if present, otherwise fall back to the placeholder config
        const firebaseConfig = hasEnvironmentConfig ? JSON.parse(__firebase_config) : PLACEHOLDER_FIREBASE_CONFIG;

        // Use environment App ID if present, otherwise use a stable ID for public deployment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'github-pages-tictactoe';

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let currentGameId = null;
        let playerSymbol = null; // 'X' or 'O'
        let unsubscribeSnapshot = null;
        let isAuthReady = false;

        // Game state template
        const initialGameState = {
            board: JSON.stringify(Array(9).fill(null)),
            playerXId: null,
            playerOId: null,
            currentPlayer: 'X',
            status: 'pending', // pending, ongoing, X_WINS, O_WINS, DRAW
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
        };

        // DOM Elements
        const appContainer = document.getElementById('app');
        const userInfoEl = document.getElementById('user-info');
        const setupContainer = document.getElementById('setup-container');
        const gameContainer = document.getElementById('game-container');
        const boardEl = document.getElementById('board');
        const statusMessageEl = document.getElementById('status-message');
        const joinGameInput = document.getElementById('join-game-input');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const newGameBtn = document.getElementById('new-game-btn');
        const playerXCard = document.getElementById('player-x-card');
        const playerOCard = document.getElementById('player-o-card');

        // --- UTILITY FUNCTIONS ---

        function showMessage(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('modal').classList.remove('hidden');
        }

        function getGameDocRef(gameId) {
            // Note: The public path is based on the hardcoded appId when running externally
            const collectionPath = `artifacts/${appId}/public/data/tictactoe`;
            return doc(db, collectionPath, gameId);
        }

        // --- GAME LOGIC ---

        function checkWinner(board) {
            const lines = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6]             // Diagonals
            ];

            for (let i = 0; i < lines.length; i++) {
                const [a, b, c] = lines[i];
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return board[a]; // Returns 'X' or 'O'
                }
            }

            if (board.every(cell => cell !== null)) {
                return 'DRAW';
            }

            return null; // Game ongoing
        }

        async function makeMove(index) {
            if (!currentGameId || !playerSymbol || !db) return;

            try {
                const docRef = getGameDocRef(currentGameId);
                const gameDoc = await getDoc(docRef);

                if (!gameDoc.exists()) {
                    showMessage("Error", "Game not found.");
                    return;
                }

                const gameData = gameDoc.data();
                const board = JSON.parse(gameData.board);

                // Check game rules before making the move
                const isMyTurn = gameData.currentPlayer === playerSymbol;
                const isGameOngoing = gameData.status === 'ongoing';
                const isCellEmpty = board[index] === null;

                if (!isAuthReady) {
                    showMessage("Authentication Error", "Please wait for user authentication to complete.");
                    return;
                }

                if (!isGameOngoing) {
                    showMessage("Game Over", `The game status is: ${gameData.status}. Start a new one.`);
                    return;
                }

                if (!isMyTurn) {
                    showMessage("Wait your turn", `It is currently Player ${gameData.currentPlayer}'s turn.`);
                    return;
                }

                if (!isCellEmpty) {
                    showMessage("Invalid Move", "This cell is already occupied.");
                    return;
                }

                // 1. Update board locally
                board[index] = playerSymbol;

                // 2. Check for winner/draw
                const winner = checkWinner(board);
                let newStatus = 'ongoing';
                let nextPlayer = playerSymbol === 'X' ? 'O' : 'X';

                if (winner === 'DRAW') {
                    newStatus = 'DRAW';
                    nextPlayer = null;
                } else if (winner) {
                    newStatus = `${winner}_WINS`;
                    nextPlayer = null;
                }

                // 3. Update Firestore (real-time push)
                await updateDoc(docRef, {
                    board: JSON.stringify(board),
                    currentPlayer: nextPlayer,
                    status: newStatus,
                    updatedAt: serverTimestamp(),
                });

            } catch (error) {
                console.error("Error making move:", error);
                showMessage("Database Error", "Failed to register move. Check console for details.");
            }
        }

        // --- UI & RENDER FUNCTIONS ---

        function renderBoard(boardArray) {
            boardEl.innerHTML = '';
            boardArray.forEach((cellValue, index) => {
                const cell = document.createElement('div');
                cell.className = `cell transition-all duration-300 ${cellValue ? 'occupied' : ''} ${playerSymbol && cellValue !== null ? (cellValue === 'X' ? 'x-player' : 'o-player') : ''}`;
                cell.textContent = cellValue || '';

                if (cellValue === null && playerSymbol) {
                    cell.addEventListener('click', () => makeMove(index));
                }
                
                boardEl.appendChild(cell);
            });
        }

        function updateGameStatus(gameData) {
            const board = JSON.parse(gameData.board);
            renderBoard(board);

            const status = gameData.status;
            let message = '';
            let styleClasses = 'bg-gray-100 text-gray-800';
            let gameFinished = false;

            // Highlight current player
            playerXCard.classList.remove('border-4', 'border-green-500', 'shadow-2xl');
            playerOCard.classList.remove('border-4', 'border-green-500', 'shadow-2xl');
            playerXCard.classList.remove('border-blue-500', 'border-red-500', 'shadow-lg');
            playerOCard.classList.remove('border-blue-500', 'border-red-500', 'shadow-lg');
            
            if (gameData.playerXId === currentUserId) playerXCard.classList.add('border-2', 'border-red-500', 'shadow-lg');
            if (gameData.playerOId === currentUserId) playerOCard.classList.add('border-2', 'border-blue-500', 'shadow-lg');

            // Handle Status
            if (status === 'pending') {
                message = playerSymbol === 'X' ?
                    `Game ID: ${currentGameId}. Waiting for an opponent to join...` :
                    `Game ID: ${currentGameId}. Waiting for X to start the game.`;
                styleClasses = 'bg-yellow-100 text-yellow-700';
            } else if (status === 'ongoing') {
                const isMyTurn = gameData.currentPlayer === playerSymbol;
                message = isMyTurn ? 
                    `Your Turn! You are ${playerSymbol}.` :
                    `Opponent's Turn (${gameData.currentPlayer}). Waiting for move...`;
                
                styleClasses = isMyTurn ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700';
                
                // Highlight the player whose turn it is
                if (gameData.currentPlayer === 'X' && (gameData.playerXId || !gameData.playerOId)) { 
                     playerXCard.classList.add('border-4', 'border-green-500', 'shadow-2xl');
                } else if (gameData.currentPlayer === 'O' && gameData.playerOId) { 
                     playerOCard.classList.add('border-4', 'border-green-500', 'shadow-2xl');
                }

            } else if (status.endsWith('_WINS')) {
                const winner = status.split('_')[0];
                const isWinner = winner === playerSymbol;
                message = isWinner ? 'ðŸŽ‰ YOU WIN! Congratulations! ðŸŽ‰' : `ðŸ˜­ Player ${winner} wins! Game over. ðŸ˜­`;
                styleClasses = isWinner ? 'bg-green-500 text-white' : 'bg-red-500 text-white';
                gameFinished = true;
            } else if (status === 'DRAW') {
                message = "ðŸ¤ It's a DRAW! Game over. ðŸ¤";
                styleClasses = 'bg-indigo-500 text-white';
                gameFinished = true;
            }

            statusMessageEl.className = `p-4 mb-4 rounded-lg font-semibold text-center transition-colors duration-300 ${styleClasses}`;
            statusMessageEl.textContent = message;

            if (gameFinished) {
                 newGameBtn.classList.remove('hidden');
            } else {
                 newGameBtn.classList.add('hidden');
            }
        }

        function startListening(gameId) {
            if (!db) return;
            if (unsubscribeSnapshot) unsubscribeSnapshot(); // Stop listening to previous game

            currentGameId = gameId;
            setupContainer.classList.add('hidden');
            gameContainer.classList.remove('hidden');

            const docRef = getGameDocRef(gameId);

            // Real-time listener for game state changes
            unsubscribeSnapshot = onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const gameData = doc.data();
                    updateGameStatus(gameData);
                } else {
                    showMessage("Game Ended", "The current game session was deleted or ended by the server.");
                    currentGameId = null;
                    playerSymbol = null;
                    if (unsubscribeSnapshot) unsubscribeSnapshot();
                    setupContainer.classList.remove('hidden');
                    gameContainer.classList.add('hidden');
                }
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                showMessage("Connection Error", "Failed to listen for real-time updates.");
            });
        }


        // --- FIREBASE AND AUTHENTICATION ---

        async function initializeAndAuthenticate() {
            try {
                // If running on GitHub Pages, the placeholders should be replaced
                if (firebaseConfig.projectId === "__SECRET_PROJECT_ID__") {
                    showMessage("Configuration Error", "Firebase configuration placeholders were not replaced. The GitHub Action likely failed or has not run yet. Check your repository Secrets.");
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userInfoEl.textContent = `Your User ID: ${currentUserId.substring(0, 8)}... (Full ID: ${currentUserId}).`;
                        isAuthReady = true;
                    } else {
                        userInfoEl.textContent = "Authenticating...";
                        currentUserId = null;
                        isAuthReady = false;
                    }
                });

                // Sign in using custom token (sandbox) or anonymously (GitHub Pages)
                if (token && hasEnvironmentConfig) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                showMessage("Initialization Error", "Failed to initialize Firebase or sign in. See console for details.");
            }
        }

        // --- HANDLERS ---

        createGameBtn.addEventListener('click', async () => {
            if (!isAuthReady) {
                 showMessage("Wait", "Please wait for authentication to complete before starting a game.");
                 return;
            }
            if (firebaseConfig.projectId === "__SECRET_PROJECT_ID__") {
                showMessage("Configuration Error", "Game cannot start. Firebase configuration missing.");
                return;
            }

            try {
                const collectionPath = `artifacts/${appId}/public/data/tictactoe`;
                const newGameRef = doc(collection(db, collectionPath));
                const newGameId = newGameRef.id;

                await setDoc(newGameRef, {
                    ...initialGameState,
                    playerXId: currentUserId,
                });

                playerSymbol = 'X';
                const gameIdMessage = `Share this ID with a friend to join: ${newGameId}`;
                const tempInput = document.createElement('input');
                tempInput.value = newGameId;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);

                showMessage("Game Created! (ID Copied)", `${gameIdMessage}. The ID has been copied to your clipboard.`);
                startListening(newGameId);

            } catch (error) {
                console.error("Error creating game:", error);
                showMessage("Error", "Failed to create a new game.");
            }
        });

        joinGameBtn.addEventListener('click', async () => {
            if (!isAuthReady) {
                 showMessage("Wait", "Please wait for authentication to complete before joining a game.");
                 return;
            }
            if (firebaseConfig.projectId === "__SECRET_PROJECT_ID__") {
                showMessage("Configuration Error", "Game cannot join. Firebase configuration missing.");
                return;
            }

            const gameId = joinGameInput.value.trim();
            if (!gameId) {
                showMessage("Input Required", "Please enter a valid Game ID.");
                return;
            }

            try {
                const docRef = getGameDocRef(gameId);
                const gameDoc = await getDoc(docRef);

                if (!gameDoc.exists()) {
                    showMessage("Not Found", "No game found with that ID.");
                    return;
                }

                const gameData = gameDoc.data();

                if (gameData.playerXId === currentUserId || gameData.playerOId === currentUserId) {
                    // Already in this game, just re-join
                    playerSymbol = gameData.playerXId === currentUserId ? 'X' : 'O';
                    showMessage("Rejoining Game", `You are already Player ${playerSymbol} in this game.`);
                    startListening(gameId);
                    return;
                }

                if (gameData.playerOId !== null) {
                    showMessage("Game Full", "This game already has two players.");
                    return;
                }

                // Join as Player O
                await updateDoc(docRef, {
                    playerOId: currentUserId,
                    status: 'ongoing', // Game starts now
                    updatedAt: serverTimestamp(),
                });

                playerSymbol = 'O';
                showMessage("Game Joined!", `You have joined the game as Player O. It is X's turn to start!`);
                startListening(gameId);

            } catch (error) {
                console.error("Error joining game:", error);
                showMessage("Error", "Failed to join game. See console for details.");
            }
        });

        newGameBtn.addEventListener('click', () => {
             // Clean up previous listeners and reset UI state
            if (unsubscribeSnapshot) unsubscribeSnapshot();
            currentGameId = null;
            playerSymbol = null;
            newGameBtn.classList.add('hidden');
            gameContainer.classList.add('hidden');
            setupContainer.classList.remove('hidden');
            joinGameInput.value = '';
            statusMessageEl.textContent = 'Ready to play!';
            renderBoard(Array(9).fill(null));
        });

        // Initialize on load
        window.onload = initializeAndAuthenticate;

    </script>
</body>
</html>