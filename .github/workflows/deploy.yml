name: Deploy Game Securely

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # STEP 1: Inject Firebase Secrets into index.html
      - name: Securely Inject Firebase Secrets
        env:
          # --- CRITICAL FIX HERE ---
          # We are now looking for secrets named "SECRET_API_KEY" instead of "FIREBASE_API_KEY"
          # to match what is inside your GitHub Repository Settings.
          API_KEY: ${{ secrets.SECRET_API_KEY }}
          AUTH_DOMAIN: ${{ secrets.SECRET_AUTH_DOMAIN }}
          PROJECT_ID: ${{ secrets.SECRET_PROJECT_ID }}
          STORAGE_BUCKET: ${{ secrets.SECRET_STORAGE_BUCKET }}
          SENDER_ID: ${{ secrets.SECRET_SENDER_ID }}
          APP_ID: ${{ secrets.SECRET_APP_ID }}
        run: |
          # The index.html has unquoted placeholders: apiKey: __SECRET_API_KEY__
          # We replace the placeholder with the quoted key: apiKey: "AIzaSy..."
          
          # If API_KEY is empty, this line produces apiKey: "" (which is what you saw in the screenshot).
          # With the correct secret name, it will produce apiKey: "AIzaSy..."
          
          sed -i "s|__SECRET_API_KEY__|\"$API_KEY\"|g" index.html
          sed -i "s|__SECRET_AUTH_DOMAIN__|\"$AUTH_DOMAIN\"|g" index.html
          sed -i "s|__SECRET_PROJECT_ID__|\"$PROJECT_ID\"|g" index.html
          sed -i "s|__SECRET_STORAGE_BUCKET__|\"$STORAGE_BUCKET\"|g" index.html
          sed -i "s|__SECRET_SENDER_ID__|\"$SENDER_ID\"|g" index.html
          sed -i "s|__SECRET_APP_ID__|\"$APP_ID\"|g" index.html
          
          echo "Secrets successfully injected into index.html."
        shell: bash
      
      # STEP 2: Upload Pages Artifact
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      # STEP 3: Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
