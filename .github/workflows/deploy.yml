# This is the simplified and robust workflow for deploying a single HTML file 
# to GitHub Pages securely via GitHub Actions.

name: Deploy Game Securely

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    # Define the deployment environment (required for deploy-pages@v4)
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # STEP 1: Inject Firebase Secrets into index.html
      - name: Securely Inject Firebase Secrets
        run: |
          # Read the contents of the index.html file
          HTML_CONTENT=$(cat index.html)

          # Perform the search and replace operations using the secrets
          HTML_CONTENT="${HTML_CONTENT/\"__SECRET_API_KEY__\"/\"${{ secrets.FIREBASE_API_KEY }}\"}"
          HTML_CONTENT="${HTML_CONTENT/\"__SECRET_AUTH_DOMAIN__\"/\"${{ secrets.FIREBASE_AUTH_DOMAIN }}\"}"
          HTML_CONTENT="${HTML_CONTENT/\"__SECRET_PROJECT_ID__\"/\"${{ secrets.FIREBASE_PROJECT_ID }}\"}"
          HTML_CONTENT="${HTML_CONTENT/\"__SECRET_STORAGE_BUCKET__\"/\"${{ secrets.FIREBASE_STORAGE_BUCKET }}\"}"
          HTML_CONTENT="${HTML_CONTENT/\"__SECRET_SENDER_ID__\"/\"${{ secrets.FIREBASE_SENDER_ID }}\"}"
          HTML_CONTENT="${HTML_CONTENT/\"__SECRET_APP_ID__\"/\"${{ secrets.FIREBASE_APP_ID }}\"}"

          # Overwrite the index.html file with the content that now contains the keys
          echo "$HTML_CONTENT" > index.html
        shell: bash
      
      # STEP 2: Upload the processed files as an artifact
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload the root directory containing the key-injected index.html
          path: '.'

      # STEP 3: Deploy the artifact to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
