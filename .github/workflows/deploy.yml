# This workflow uses the most robust shell quoting to ensure Firebase secrets 
# are injected as perfect JavaScript string literals, eliminating SyntaxErrors.

name: Deploy Game Securely

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    # Define the deployment environment (required for deploy-pages@v4)
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # STEP 1: Inject Firebase Secrets into index.html using 'sed'
      # The key change is the complex, robust quoting: '"'"${{ secrets.SECRET_NAME }}"'"'
      # This ensures the injected value is wrapped in literal double-quotes.
      - name: Securely Inject Firebase Secrets
        run: |
          # The complex quoting pattern forces the secret value to be a quoted string.
          
          # Helper function for robust sed replacement
          # Usage: replace_secret SECRET_NAME PLACEHHOLDER_KEY
          replace_secret() {
            local secret_name=$1
            local placeholder_key=$2
            # The pattern 's|OLD|'"$NEW"'|g' is the most robust way to inject variables 
            # as literal strings within double quotes in a shell environment.
            sed -i -e "s|${placeholder_key}|'\"'\"${{ secrets[secret_name] }}\"'\"'\"|g" index.html
          }
          
          # Run replacements for all six keys
          replace_secret FIREBASE_API_KEY __SECRET_API_KEY__
          replace_secret FIREBASE_AUTH_DOMAIN __SECRET_AUTH_DOMAIN__
          replace_secret FIREBASE_PROJECT_ID __SECRET_PROJECT_ID__
          replace_secret FIREBASE_STORAGE_BUCKET __SECRET_STORAGE_BUCKET__
          replace_secret FIREBASE_SENDER_ID __SECRET_SENDER_ID__
          replace_secret FIREBASE_APP_ID __SECRET_APP_ID__
          
          echo "Secrets successfully injected into index.html."
        shell: bash
      
      # STEP 2: Upload the processed files as an artifact
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      # STEP 3: Deploy the artifact to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
