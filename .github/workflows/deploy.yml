# This workflow maps secrets to environment variables to safely inject them
# into the HTML, fixing the "Unrecognized named-value" error.

name: Deploy Game Securely

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # STEP 1: Inject Firebase Secrets into index.html
      # We map secrets to environment variables first. This allows the shell 
      # script to access them safely without complex interpolation logic.
      - name: Securely Inject Firebase Secrets
        env:
          # Map GitHub Secrets to Shell Environment Variables
          API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          SENDER_ID: ${{ secrets.FIREBASE_SENDER_ID }}
          APP_ID: ${{ secrets.FIREBASE_APP_ID }}
        run: |
          # Use sed to replace the placeholders with the environment variables.
          # We explicitly wrap the variable in escaped double quotes (\") to create
          # a valid JavaScript string (e.g., apiKey: "AIzaSy...").
          
          sed -i "s|__SECRET_API_KEY__|\"$API_KEY\"|g" index.html
          sed -i "s|__SECRET_AUTH_DOMAIN__|\"$AUTH_DOMAIN\"|g" index.html
          sed -i "s|__SECRET_PROJECT_ID__|\"$PROJECT_ID\"|g" index.html
          sed -i "s|__SECRET_STORAGE_BUCKET__|\"$STORAGE_BUCKET\"|g" index.html
          sed -i "s|__SECRET_SENDER_ID__|\"$SENDER_ID\"|g" index.html
          sed -i "s|__SECRET_APP_ID__|\"$APP_ID\"|g" index.html
          
          echo "Secrets successfully injected into index.html."
        shell: bash
      
      # STEP 2: Upload the processed files as an artifact
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      # STEP 3: Deploy the artifact to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
