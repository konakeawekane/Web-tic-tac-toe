# This is the simplified and robust workflow for deploying a single HTML file 
# to GitHub Pages securely via GitHub Actions.

name: Deploy Game Securely

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    # Define the deployment environment (required for deploy-pages@v4)
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # STEP 1: Inject Firebase Secrets into index.html using 'sed'
      # The key change is wrapping the secret variable with quotes (e.g., \"${{ secrets.SECRET_NAME }}\") 
      # to ensure the final output is a valid JavaScript string literal.
      - name: Securely Inject Firebase Secrets
        run: |
          # Use 'sed' for reliable string replacement. 
          
          # 1. API KEY (Injection now includes quotes)
          sed -i "s|__SECRET_API_KEY__|\"${{ secrets.FIREBASE_API_KEY }}\"|g" index.html
          
          # 2. AUTH DOMAIN
          sed -i "s|__SECRET_AUTH_DOMAIN__|\"${{ secrets.FIREBASE_AUTH_DOMAIN }}\"|g" index.html
          
          # 3. PROJECT ID
          sed -i "s|__SECRET_PROJECT_ID__|\"${{ secrets.FIREBASE_PROJECT_ID }}\"|g" index.html
          
          # 4. STORAGE BUCKET
          sed -i "s|__SECRET_STORAGE_BUCKET__|\"${{ secrets.FIREBASE_STORAGE_BUCKET }}\"|g" index.html
          
          # 5. SENDER ID
          sed -i "s|__SECRET_SENDER_ID__|\"${{ secrets.FIREBASE_SENDER_ID }}\"|g" index.html
          
          # 6. APP ID
          sed -i "s|__SECRET_APP_ID__|\"${{ secrets.FIREBASE_APP_ID }}\"|g" index.html
          
          echo "Secrets successfully injected into index.html."
        shell: bash
      
      # STEP 2: Upload the processed files as an artifact
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload the root directory containing the key-injected index.html
          path: '.'

      # STEP 3: Deploy the artifact to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
