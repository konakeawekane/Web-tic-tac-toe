# This workflow runs when changes are pushed to the 'main' branch.
# It uses the repository secrets to securely inject Firebase keys into index.html
# and then deploys the resulting file to GitHub Pages.

name: Deploy Game to GitHub Pages

on:
  push:
    branches:
      - main
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions needed for GitHub Pages deployment
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Inject Firebase Secrets into index.html
        run: |
          # Read the contents of the index.html file
          HTML_CONTENT=$(cat index.html)

          # Perform the search and replace operations using the secrets
          # We use single quotes around the values to ensure no shell expansion occurs
          HTML_CONTENT="${HTML_CONTENT/\"__SECRET_API_KEY__\"/\"${{ secrets.FIREBASE_API_KEY }}\"}"
          HTML_CONTENT="${HTML_CONTENT/\"__SECRET_AUTH_DOMAIN__\"/\"${{ secrets.FIREBASE_AUTH_DOMAIN }}\"}"
          HTML_CONTENT="${HTML_CONTENT/\"__SECRET_PROJECT_ID__\"/\"${{ secrets.FIREBASE_PROJECT_ID }}\"}"
          HTML_CONTENT="${HTML_CONTENT/\"__SECRET_STORAGE_BUCKET__\"/\"${{ secrets.FIREBASE_STORAGE_BUCKET }}\"}"
          HTML_CONTENT="${HTML_CONTENT/\"__SECRET_SENDER_ID__\"/\"${{ secrets.FIREBASE_SENDER_ID }}\"}"
          HTML_CONTENT="${HTML_CONTENT/\"__SECRET_APP_ID__\"/\"${{ secrets.FIREBASE_APP_ID }}\"}"

          # Overwrite the index.html file with the content that now contains the keys
          echo "$HTML_CONTENT" > index.html
        shell: bash
      
      - name: Setup Pages
        uses: actions/configure-pages@v5
        with:
          static_site_generator: custom

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload the root directory containing index.html
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4